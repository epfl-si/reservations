- name: "{{ reservations_image_name }} Docker image: local build"
  docker_image:
    name: "{{ reservations_image_name }}"
    source: build
    force_source: true
    build:
      path: '{{ resasible_dir }}/..'
  register: reservations_image

- name: "{{ reservations_image_name }} Docker image: push to OpenShift"
  # We shouldn't need this, as idempotent pushes should be de-duped by their SHA256...
  # But that doesn't quite work as of now, so we do.
  when: >-
    (reservations_image | default({})) is changed
  docker_image:
    name: "{{ reservations_image_name }}"
    source: local
    push: true

- name: "Promote test image to production"
  shell:
    cmd: |
      oc tag reservations-test/reservations:test \
             reservations-prod/reservations:prod
  tags:
    - never
    - reservations.promote
